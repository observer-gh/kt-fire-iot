<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>멀티 소켓 WebSocket 테스트</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .socket-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .socket-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
        }
        .socket-panel.active {
            border-color: #28a745;
            box-shadow: 0 4px 20px rgba(40, 167, 69, 0.3);
        }
        .socket-panel.inactive {
            border-color: #dc3545;
            opacity: 0.7;
        }
        .socket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        .socket-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .socket-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .socket-status.connected {
            background: #d4edda;
            color: #155724;
        }
        .socket-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        .socket-status.connecting {
            background: #fff3cd;
            color: #856404;
        }
        .controls {
            margin: 15px 0;
            text-align: center;
        }
        .btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 3px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .btn:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }
        .btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        .btn-success {
            background-color: #28a745;
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .stat-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .message-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        .log-title {
            font-weight: bold;
            color: #333;
        }
        .log-count {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            border-left: 3px solid #007bff;
            background: white;
        }
        .log-entry.frame {
            border-left-color: #28a745;
            background: #f8fff9;
        }
        .log-entry.error {
            border-left-color: #dc3545;
            background: #fff8f8;
            color: #721c24;
        }
        .log-entry.info {
            border-left-color: #17a2b8;
            background: #f8f9fa;
        }
        .global-controls {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .global-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .global-stat {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .global-stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .global-stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        .comparison-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        .comparison-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }
        .comparison-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        .highlight {
            background: #fff3cd !important;
            font-weight: bold;
        }
        .timestamp {
            color: #666;
            font-size: 11px;
        }
        .message-type {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            margin-right: 5px;
        }
        .message-type.frame {
            background: #d4edda;
            color: #155724;
        }
        .message-type.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        .message-type.error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔌 멀티 소켓 WebSocket 테스트</h1>
            <p>하나의 브라우저에서 두 개의 WebSocket 소켓이 동일한 토픽을 수신하는 테스트</p>
        </div>

        <div class="global-controls">
            <h3>🌐 전역 제어</h3>
            <button class="btn btn-success" onclick="connectAllSockets()">모든 소켓 연결</button>
            <button class="btn btn-danger" onclick="disconnectAllSockets()">모든 소켓 해제</button>
            <button class="btn btn-warning" onclick="clearAllLogs()">모든 로그 삭제</button>
            <button class="btn" onclick="startStreaming()">스트리밍 시작</button>
            <button class="btn" onclick="stopStreaming()">스트리밍 중지</button>
        </div>

        <div class="global-stats">
            <div class="global-stat">
                <div class="global-stat-value" id="totalMessages">0</div>
                <div class="global-stat-label">총 메시지 수</div>
            </div>
            <div class="global-stat">
                <div class="global-stat-value" id="activeSockets">0</div>
                <div class="global-stat-label">활성 소켓 수</div>
            </div>
            <div class="global-stat">
                <div class="global-stat-value" id="totalFrames">0</div>
                <div class="global-stat-label">총 프레임 수</div>
            </div>
            <div class="global-stat">
                <div class="global-stat-value" id="avgLatency">0ms</div>
                <div class="global-stat-label">평균 지연시간</div>
            </div>
        </div>

        <div class="socket-container">
            <!-- 소켓 1 -->
            <div class="socket-panel" id="socket1-panel">
                <div class="socket-header">
                    <div class="socket-title">🔌 소켓 1 (Socket-1)</div>
                    <span class="socket-status disconnected" id="socket1-status">연결 해제됨</span>
                </div>
                
                <div class="controls">
                    <button class="btn btn-success" onclick="connectSocket(1)">연결</button>
                    <button class="btn btn-danger" onclick="disconnectSocket(1)">해제</button>
                    <button class="btn" onclick="clearLog(1)">로그 삭제</button>
                </div>

                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-label">메시지 수</div>
                        <div class="stat-value" id="socket1-message-count">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">프레임 수</div>
                        <div class="stat-value" id="socket1-frame-count">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">마지막 수신</div>
                        <div class="stat-value" id="socket1-last-received">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">연결 시간</div>
                        <div class="stat-value" id="socket1-connection-time">-</div>
                    </div>
                </div>

                <div class="message-log">
                    <div class="log-header">
                        <span class="log-title">메시지 로그</span>
                        <span class="log-count" id="socket1-log-count">0</span>
                    </div>
                    <div id="socket1-log-container"></div>
                </div>
            </div>

            <!-- 소켓 2 -->
            <div class="socket-panel" id="socket2-panel">
                <div class="socket-header">
                    <div class="socket-title">🔌 소켓 2 (Socket-2)</div>
                    <span class="socket-status disconnected" id="socket2-status">연결 해제됨</span>
                </div>
                
                <div class="controls">
                    <button class="btn btn-success" onclick="connectSocket(2)">연결</button>
                    <button class="btn btn-danger" onclick="disconnectSocket(2)">해제</button>
                    <button class="btn" onclick="clearLog(2)">로그 삭제</button>
                </div>

                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-label">메시지 수</div>
                        <div class="stat-value" id="socket2-message-count">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">프레임 수</div>
                        <div class="stat-value" id="socket2-frame-count">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">마지막 수신</div>
                        <div class="stat-value" id="socket2-last-received">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">연결 시간</div>
                        <div class="stat-value" id="socket2-connection-time">-</div>
                    </div>
                </div>

                <div class="message-log">
                    <div class="log-header">
                        <span class="log-title">메시지 로그</span>
                        <span class="log-count" id="socket2-log-count">0</span>
                    </div>
                    <div id="socket2-log-container"></div>
                </div>
            </div>
        </div>

        <div class="comparison-panel">
            <h3>📊 소켓 비교 분석</h3>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>항목</th>
                        <th>소켓 1</th>
                        <th>소켓 2</th>
                        <th>차이</th>
                        <th>상태</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>메시지 수</td>
                        <td id="comp-socket1-messages">0</td>
                        <td id="comp-socket2-messages">0</td>
                        <td id="comp-message-diff">0</td>
                        <td id="comp-message-status">-</td>
                    </tr>
                    <tr>
                        <td>프레임 수</td>
                        <td id="comp-socket1-frames">0</td>
                        <td id="comp-socket2-frames">0</td>
                        <td id="comp-frame-diff">0</td>
                        <td id="comp-frame-status">-</td>
                    </tr>
                    <tr>
                        <td>연결 시간</td>
                        <td id="comp-socket1-time">-</td>
                        <td id="comp-socket2-time">-</td>
                        <td id="comp-time-diff">-</td>
                        <td id="comp-time-status">-</td>
                    </tr>
                    <tr>
                        <td>마지막 수신</td>
                        <td id="comp-socket1-last">-</td>
                        <td id="comp-socket2-last">-</td>
                        <td id="comp-last-diff">-</td>
                        <td id="comp-last-status">-</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // 전역 변수
        let socket1 = null;
        let socket2 = null;
        let globalStats = {
            totalMessages: 0,
            activeSockets: 0,
            totalFrames: 0,
            totalLatency: 0,
            latencyCount: 0
        };

        // 소켓 상태 관리
        const socketStates = {
            1: { connected: false, messageCount: 0, frameCount: 0, lastReceived: '-', connectionTime: '-' },
            2: { connected: false, messageCount: 0, frameCount: 0, lastReceived: '-', connectionTime: '-' }
        };

        // 소켓 연결
        function connectSocket(socketNum) {
            const socket = new SockJS('/cctv-websocket');
            const stompClient = Stomp.over(socket);
            
            updateSocketStatus(socketNum, 'connecting');
            
            stompClient.connect({}, function (frame) {
                console.log(`소켓 ${socketNum} 연결 성공:`, frame);
                
                // CCTV 스트림 구독
                stompClient.subscribe('/topic/cctv-stream', function (message) {
                    const frameData = JSON.parse(message.body);
                    handleMessage(socketNum, frameData);
                });
                
                // 소켓 저장
                if (socketNum === 1) {
                    socket1 = stompClient;
                } else {
                    socket2 = stompClient;
                }
                
                updateSocketStatus(socketNum, 'connected');
                updateSocketStats(socketNum, 'connectionTime', new Date().toLocaleTimeString());
                
                addLog(socketNum, 'WebSocket 연결 성공', 'info');
                
            }, function (error) {
                console.error(`소켓 ${socketNum} 연결 실패:`, error);
                updateSocketStatus(socketNum, 'disconnected');
                addLog(socketNum, `WebSocket 연결 실패: ${error}`, 'error');
            });
        }

        // 소켓 해제
        function disconnectSocket(socketNum) {
            let stompClient = null;
            if (socketNum === 1) {
                stompClient = socket1;
                socket1 = null;
            } else {
                stompClient = socket2;
                socket2 = null;
            }
            
            if (stompClient) {
                stompClient.disconnect();
                addLog(socketNum, 'WebSocket 연결 해제', 'info');
            }
            
            updateSocketStatus(socketNum, 'disconnected');
            updateSocketStats(socketNum, 'connectionTime', '-');
        }

        // 모든 소켓 연결
        function connectAllSockets() {
            connectSocket(1);
            connectSocket(2);
        }

        // 모든 소켓 해제
        function disconnectAllSockets() {
            disconnectSocket(1);
            disconnectSocket(2);
        }

        // 메시지 처리
        function handleMessage(socketNum, frameData) {
            const receiveTime = new Date();
            const timestamp = receiveTime.toLocaleTimeString();
            
            // 메시지 수 증가
            socketStates[socketNum].messageCount++;
            socketStates[socketNum].lastReceived = timestamp;
            
            // 프레임 수 증가 (비디오 프레임인 경우)
            if (frameData.type === 'video_frame') {
                socketStates[socketNum].frameCount++;
                globalStats.totalFrames++;
                
                // 지연시간 계산 (서버 타임스탬프와 비교)
                if (frameData.timestamp) {
                    const latency = receiveTime.getTime() - frameData.timestamp;
                    globalStats.totalLatency += latency;
                    globalStats.latencyCount++;
                }
            }
            
            // 전역 통계 업데이트
            globalStats.totalMessages++;
            
            // UI 업데이트
            updateSocketStats(socketNum, 'messageCount', socketStates[socketNum].messageCount);
            updateSocketStats(socketNum, 'frameCount', socketStates[socketNum].frameCount);
            updateSocketStats(socketNum, 'lastReceived', timestamp);
            updateGlobalStats();
            updateComparisonTable();
            
            // 로그 추가
            if (frameData.type === 'video_frame') {
                addLog(socketNum, `프레임 수신: ${frameData.frameNumber} (${frameData.videoPath})`, 'frame');
            } else {
                addLog(socketNum, `메시지 수신: ${JSON.stringify(frameData)}`, 'info');
            }
        }

        // 소켓 상태 업데이트
        function updateSocketStatus(socketNum, status) {
            const statusElement = document.getElementById(`socket${socketNum}-status`);
            const panelElement = document.getElementById(`socket${socketNum}-panel`);
            
            socketStates[socketNum].connected = (status === 'connected');
            
            statusElement.textContent = getStatusText(status);
            statusElement.className = `socket-status ${status}`;
            
            // 패널 스타일 업데이트
            panelElement.className = `socket-panel ${status}`;
            
            // 전역 통계 업데이트
            updateGlobalStats();
        }

        // 상태 텍스트 변환
        function getStatusText(status) {
            switch (status) {
                case 'connected': return '연결됨';
                case 'disconnected': return '연결 해제됨';
                case 'connecting': return '연결 중...';
                default: return '알 수 없음';
            }
        }

        // 소켓 통계 업데이트
        function updateSocketStats(socketNum, statType, value) {
            const element = document.getElementById(`socket${socketNum}-${statType.replace(/([A-Z])/g, '-$1').toLowerCase()}`);
            if (element) {
                element.textContent = value;
            }
        }

        // 전역 통계 업데이트
        function updateGlobalStats() {
            document.getElementById('totalMessages').textContent = globalStats.totalMessages;
            document.getElementById('activeSockets').textContent = 
                (socketStates[1].connected ? 1 : 0) + (socketStates[2].connected ? 1 : 0);
            document.getElementById('totalFrames').textContent = globalStats.totalFrames;
            
            const avgLatency = globalStats.latencyCount > 0 ? 
                Math.round(globalStats.totalLatency / globalStats.latencyCount) : 0;
            document.getElementById('avgLatency').textContent = `${avgLatency}ms`;
        }

        // 비교 테이블 업데이트
        function updateComparisonTable() {
            // 메시지 수 비교
            const messageDiff = Math.abs(socketStates[1].messageCount - socketStates[2].messageCount);
            document.getElementById('comp-socket1-messages').textContent = socketStates[1].messageCount;
            document.getElementById('comp-socket2-messages').textContent = socketStates[2].messageCount;
            document.getElementById('comp-message-diff').textContent = messageDiff;
            document.getElementById('comp-message-status').textContent = 
                messageDiff === 0 ? '동기화됨' : '차이 있음';
            
            // 프레임 수 비교
            const frameDiff = Math.abs(socketStates[1].frameCount - socketStates[2].frameCount);
            document.getElementById('comp-socket1-frames').textContent = socketStates[1].frameCount;
            document.getElementById('comp-socket2-frames').textContent = socketStates[2].frameCount;
            document.getElementById('comp-frame-diff').textContent = frameDiff;
            document.getElementById('comp-frame-status').textContent = 
                frameDiff === 0 ? '동기화됨' : '차이 있음';
            
            // 연결 시간 비교
            document.getElementById('comp-socket1-time').textContent = socketStates[1].connectionTime;
            document.getElementById('comp-socket2-time').textContent = socketStates[2].connectionTime;
            document.getElementById('comp-time-diff').textContent = '-';
            document.getElementById('comp-time-status').textContent = '-';
            
            // 마지막 수신 시간 비교
            document.getElementById('comp-socket1-last').textContent = socketStates[1].lastReceived;
            document.getElementById('comp-socket2-last').textContent = socketStates[2].lastReceived;
            document.getElementById('comp-last-diff').textContent = '-';
            document.getElementById('comp-last-status').textContent = '-';
            
            // 하이라이트 처리
            highlightDifferences();
        }

        // 차이점 하이라이트
        function highlightDifferences() {
            const rows = document.querySelectorAll('.comparison-table tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 4) {
                    const diffCell = cells[3];
                    const statusCell = cells[4];
                    
                    if (diffCell.textContent !== '0' && diffCell.textContent !== '-') {
                        row.classList.add('highlight');
                    } else {
                        row.classList.remove('highlight');
                    }
                }
            });
        }

        // 로그 추가
        function addLog(socketNum, message, type = 'info') {
            const logContainer = document.getElementById(`socket${socketNum}-log-container`);
            const logCountElement = document.getElementById(`socket${socketNum}-log-count`);
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            const typeLabel = getTypeLabel(type);
            
            logEntry.innerHTML = `
                <span class="timestamp">[${timestamp}]</span>
                <span class="message-type ${type}">${typeLabel}</span>
                ${message}
            `;
            
            logContainer.appendChild(logEntry);
            
            // 로그 수 업데이트
            const currentCount = logContainer.children.length;
            logCountElement.textContent = currentCount;
            
            // 자동 스크롤
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // 최대 100개 로그 유지
            if (currentCount > 100) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        // 타입 라벨 변환
        function getTypeLabel(type) {
            switch (type) {
                case 'frame': return 'FRAME';
                case 'error': return 'ERROR';
                case 'info': return 'INFO';
                default: return 'LOG';
            }
        }

        // 로그 삭제
        function clearLog(socketNum) {
            const logContainer = document.getElementById(`socket${socketNum}-log-container`);
            const logCountElement = document.getElementById(`socket${socketNum}-log-count`);
            
            logContainer.innerHTML = '';
            logCountElement.textContent = '0';
        }

        // 모든 로그 삭제
        function clearAllLogs() {
            clearLog(1);
            clearLog(2);
        }

        // 스트리밍 시작
        function startStreaming() {
            fetch('/api/cctv/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog(1, '스트리밍 시작 요청 성공', 'info');
                    addLog(2, '스트리밍 시작 요청 성공', 'info');
                } else {
                    addLog(1, '스트리밍 시작 실패: ' + data.message, 'error');
                    addLog(2, '스트리밍 시작 실패: ' + data.message, 'error');
                }
            })
            .catch(error => {
                addLog(1, '스트리밍 시작 요청 오류: ' + error, 'error');
                addLog(2, '스트리밍 시작 요청 오류: ' + error, 'error');
            });
        }

        // 스트리밍 중지
        function stopStreaming() {
            fetch('/api/cctv/stop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog(1, '스트리밍 중지 요청 성공', 'info');
                    addLog(2, '스트리밍 중지 요청 성공', 'info');
                } else {
                    addLog(1, '스트리밍 중지 실패: ' + data.message, 'error');
                    addLog(2, '스트리밍 중지 실패: ' + data.message, 'error');
                }
            })
            .catch(error => {
                addLog(1, '스트리밍 중지 요청 오류: ' + error, 'error');
                addLog(2, '스트리밍 중지 요청 오류: ' + error, 'error');
            });
        }

        // 페이지 로드 시 초기화
        window.onload = function() {
            addLog(1, '멀티 소켓 테스트 페이지 로드됨', 'info');
            addLog(2, '멀티 소켓 테스트 페이지 로드됨', 'info');
            updateGlobalStats();
            updateComparisonTable();
        };

        // 페이지 종료 시 연결 해제
        window.onbeforeunload = function() {
            disconnectAllSockets();
        };
    </script>
</body>
</html>
